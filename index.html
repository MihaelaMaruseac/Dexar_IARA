<!DOCTYPE html>
<html>
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <!-- we import arjs version without NFT but with marker + location based support -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js" integrity="sha512-tVYBzEItJit9HXaWTPo8vveXlkK62LbA+wez9IgzjTmFNLMBO1BEYladBw2wnM3YURZSMUyhayPCoLtjGh84NQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.min.js" integrity="sha512-u9akINsQsAkG9xjc1cnGF4zw5TFDwkxuc9vUp5dltDWYCSmyd0meygbvgXrlc/z7/o4a19Fb5V0OUE58J7dcyw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.3/firebase.js"></script>
  <script>
        
      const firebaseConfig = {
        apiKey: "AIzaSyD4G7cQzr3UDURc72xoFEPC3KWECzlpgg0",
        authDomain: "dexar-6c0bd.firebaseapp.com",
        databaseURL: "https://dexar-6c0bd-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "dexar-6c0bd",
        storageBucket: "dexar-6c0bd.appspot.com",
        messagingSenderId: "537242336725",
        appId: "1:537242336725:web:6964ec85ac75fab503915c",
        measurementId: "G-2F7NKSVTF0"
      };
 
          firebase.initializeApp(firebaseConfig);
          
    const openWebcam = async () => {
      const webcamElement = document.getElementById('webcam');
      const stream = await navigator.mediaDevices.getUserMedia({
          video: {
              facingMode: 'environment',
              zoom: false
              // aspectRatio: { exact: 0.7777777778 }
          },
          audio: false
      })
	    webcamElement.srcObject = stream;
    }
          
    window.onload = async function () {
      await openWebcam()
      document
        .querySelector(".take-word-button")
        .addEventListener("click", function () {
          // here you can change also a-scene or a-entity properties, like
          // changing your 3D model source, size, position and so on
          // or you can just open links, trigger actions...
          // alert("Hi there!");
          capture();
        });
    };
    
    const b64toBlob = (b64Data, contentType = 'image/png', sliceSize = 512) => {
      const byteCharacters = atob(b64Data);
      const byteArrays = [];
    
      for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
    
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }
    
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
      }
    
      const blob = new Blob(byteArrays, { type: contentType });
      return blob;
    }

    //  uploading file in storage
    async function uploadimage(base64){
      var storage = firebase.storage();
      const file = b64toBlob(base64.split(';base64,')[1]);
      var storageref=storage.ref();
      var thisref=storageref.child("image/png").child("abc.png").put(file);
    }

    // Function to get form values
    function getInputVal(id){
      return document.getElementById(id).value;
    }
        
    // Save message to firebase database
    function saveMessage(url){
      var newMessageRef = messagesRef.push();
      newMessageRef.set({
      imageurl:url,
      });
    }

    
    const capture = async () => {      

      // const screenshotTarget = document.body;
      const webcamElement = document.getElementById('webcam');
      console.log("97: ", window.innerWidth, window.innerHeight);
      const canvas = document.getElementById("canvas");
      
      
      const box= document.getElementById('box');
      console.log("101: ", box, box.getBoundingClientRect())
      const position = box.getBoundingClientRect();
      // canvas.getContext('2d').drawImage(webcamElement, position.left,position.top, 155,45,     0, 0, canvas.width, canvas.height);
   	  canvas.getContext('2d').drawImage(webcamElement, window.innerWidth/2 -10  , window.innerHeight/2 - 55, 155,45,     0, 0, canvas.width, canvas.height);
   	 
   	  let image_data_url = canvas.toDataURL('image/jpeg');

   	// data url of the image
   	console.log("124: ", image_data_url);


      // html2canvas(screenshotTarget).then(async (canvas) => {
          var messagesRef = await firebase.database().ref('Checking');
          // const base64image = canvas.toDataURL("image/png");
          await uploadimage(image_data_url);
          alert("Uploaded image")
          
          var url = 'https://script.google.com/macros/s/AKfycbxebhtQBjtNfGMO_3Bium-SuIB4Bs6YLxamDwOIgfvC/exec?callback=resultServer&caller=Mihaela';
          // Make an AJAX call to Google Script
          try{
            console.log("112")
            const result = await jQuery.ajax({
              crossDomain: true,
              url: url,
              method: "GET",
              dataType: "jsonp"
            });
            console.log("119")
          } catch (err) {
            console.log("97: ", err);
          }
      // });
      
    };
    
    function resultServer(e) {
        console.log("128", e);
        const result = e.result;
        console.log("130: ", result);
    }

    
    
  </script>
  <style>
    .buttons {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 10em;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .take-word-button {
      padding: 0.25em;
      border-radius: 4px;
      border: 1px solid #CCFF00;
      background:#66CC99;
      color: black;
      width: 7em;
      height: 4em;
      font-weight: bold;
    }
    
    .word-box{
      width: 155px;
      height: 45px;
      position: absolute;
      top: 50%;
      left: 50%;
      margin-right: -50%;
      transform: translate(-50%, -50%);
    }
    
  </style>
  <body style="margin : 0px; overflow: hidden;">
  <canvas id="canvas" width="155" height="45" style="display: none;"></canvas>
    <video id="webcam" width="1280" height="720" autoplay playsinline style="display: none;"></video>
    <div class="buttons">
      <button class="take-word-button">Capture the unknown word!</button>
    </div>
    <div class="word-box" style= "border: 4px solid green" id='box'>
    </div>
    <a-scene embedded arjs vr-mode-ui="enabled: false;">
      <a-marker preset="hiro">
        <a-entity
          position="0 0 0"
          scale="0.05 0.05 0.05"
          gltf-model="https://arjs-cors-proxy.herokuapp.com/https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/scene.gltf"
        ></a-entity>
      </a-marker>
      <a-marker preset='kanji'>
        <a-box position='0 0.5 0' material='opacity: 0.5;'></a-box>
      </a-marker>
      <!--<a-marker preset="custom" type="pattern" url="https://drive.google.com/file/d/1Eo6vCIjvnDWduSyyQUzl0lf4EZljBCBk/view?usp=sharing">-->
        <!--<a-entity-->
        <!--   position="0 0 0"-->
        <!--  scale="0.05 0.05 0.05"-->
        <!--  > -->
        <!--</a-entity>-->
        <!--<a-box position='0 0.5 0' material='opacity: 0.5;'></a-box>-->
      <!--</a-marker>-->
      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>