<!DOCTYPE html>
<html>
<head> 
<!--<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">-->
<!--</head>-->
  <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
  <!-- we import arjs version without NFT but with marker + location based support -->
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js" integrity="sha512-tVYBzEItJit9HXaWTPo8vveXlkK62LbA+wez9IgzjTmFNLMBO1BEYladBw2wnM3YURZSMUyhayPCoLtjGh84NQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.min.js" integrity="sha512-u9akINsQsAkG9xjc1cnGF4zw5TFDwkxuc9vUp5dltDWYCSmyd0meygbvgXrlc/z7/o4a19Fb5V0OUE58J7dcyw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/8.2.3/firebase.js"></script>
  <script>
        
      const firebaseConfig = {
        apiKey: "AIzaSyD4G7cQzr3UDURc72xoFEPC3KWECzlpgg0",
        authDomain: "dexar-6c0bd.firebaseapp.com",
        databaseURL: "https://dexar-6c0bd-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "dexar-6c0bd",
        storageBucket: "dexar-6c0bd.appspot.com",
        messagingSenderId: "537242336725",
        appId: "1:537242336725:web:6964ec85ac75fab503915c",
        measurementId: "G-2F7NKSVTF0"
      };
 
          firebase.initializeApp(firebaseConfig);
          
    const openWebcam = async () => {
      const webcamElement = document.getElementById('webcam');
      const stream = await navigator.mediaDevices.getUserMedia({
          video: {
              facingMode: 'environment',
              // deviceId: 'd964cdb222e31562074b4008b509fbb32a0ddbde61d0a1638fd23b4569552c7a
          },
          audio: false
      })
      // alert(stream)
	    webcamElement.srcObject = stream;
      
    //   const devices = await navigator.mediaDevices.enumerateDevices() 
    //   alert(devices)
	   
	   
	   //var userMediaConstraints = {
    //   audio: false,
    //   video: {
    //     facingMode: 'environment',
    //     // width: {
    //     // ideal: _this.parameters.sourceWidth,
    //     // // min: 1024,
    //     // // max: 1920
    //     // },
    //     width: window.innerWidth,
    //     height: window.innerHeight
    //     // height: {
    //     // ideal: _this.parameters.sourceHeight,
    //     // // min: 776,
    //     // // max: 1080
    //     // }
    //   }
    // }
    // alert(JSON.stringify(userMediaConstraints))
    
    // let stream;
        
    //     // CUSTOM CODE START
    //     var backCam2 = devices.filter(d=>{
    //     return d.label && d.label == "camera2 0, facing back";
    //     })
    //     alert(JSON.stringify(backCam2))
    //     if (backCam2.length) {
    //     userMediaConstraints.video.deviceId = backCam2[0].deviceId
    //     stream = await navigator.mediaDevices.getUserMedia(userMediaConstraints)
    //     } else {
    //       stream = await navigator.mediaDevices.getUserMedia({
    //       video: {
    //           facingMode: 'environment'
    //       },
    //       audio: false
    //       })
    //     }
    //     // CUSTOM CODE END
    //     // alert(JSON.stringify(userMediaConstraints))

    //   const webcamElement = document.getElementById('webcam');
    //   // const stream = await navigator.mediaDevices.getUserMedia(userMediaConstraints)
    //   alert(JSON.stringify(stream))
	   // webcamElement.srcObject = stream;
	   // webcamElement.play()
    }
          
    window.onload = async function () {
      await openWebcam()
      document
        .querySelector(".take-word-button")
        .addEventListener("click", function () {
          // here you can change also a-scene or a-entity properties, like
          // changing your 3D model source, size, position and so on
          // or you can just open links, trigger actions...
          // alert("Hi there!");
          capture();
        });
    };
    
    const b64toBlob = (b64Data, contentType = 'image/png', sliceSize = 512) => {
      const byteCharacters = atob(b64Data);
      const byteArrays = [];
    
      for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
        const slice = byteCharacters.slice(offset, offset + sliceSize);
    
        const byteNumbers = new Array(slice.length);
        for (let i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }
    
        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
      }
    
      const blob = new Blob(byteArrays, { type: contentType });
      return blob;
    }

    //  uploading file in storage
    async function uploadimage(base64){
      var storage = firebase.storage();
      const file = b64toBlob(base64.split(';base64,')[1]);
      var storageref=storage.ref();
      var thisref=storageref.child("image/png").child("abc.png").put(file);
    }

    // Function to get form values
    function getInputVal(id){
      return document.getElementById(id).value;
    }
        
    // Save message to firebase database
    function saveMessage(url){
      var newMessageRef = messagesRef.push();
      newMessageRef.set({
      imageurl:url,
      });
    }

    
    const capture = async () => {      
      const webcamElement = document.getElementById('webcam');
      const canvas = document.getElementById("canvas");
      canvas.getContext('2d').drawImage(webcamElement, window.innerWidth/2 -10, window.innerHeight/2 - 55, 155,45, 0, 0, canvas.width, canvas.height);
   	  let image_data_url = canvas.toDataURL('image/jpeg');
      await uploadimage(image_data_url);
          alert("Uploaded image")
          
          var url = 'https://script.google.com/macros/s/AKfycbxebhtQBjtNfGMO_3Bium-SuIB4Bs6YLxamDwOIgfvC/exec?callback=resultServer&caller=Mihaela';
          // Make an AJAX call to Google Script
          try{
            const result = await jQuery.ajax({
              crossDomain: true,
              url: url,
              method: "GET",
              dataType: "jsonp"
            });
          } catch (err) {
            console.log("97: ", err);
          }
      // });
      
    };
    
    async function resultServer(e) {
        const result = e.result.split(' ');
        let found = false;
        alert("txt: "+ result)
        var regExp = /[a-zA-Z]/g;

        for(let i=0; i<result.length;i++){
          if(regExp.test(result[i])){
            await callDex(result[i]);
            found = true;
            break
          }
        }

        alert(found);
        
        if(!found){
          // sad 
          const scene = document.getElementById("scene");
          console.log("190", scene)
          const entity = document.createElement("a-entity");
          entity.innerHTML = "<img src=\"./sad1.jpg\" width=\"400px\" height=\"150px\">";
          console.log("192", entity)
          // const img = document.createElement("img");
          // img.src = './sad1.jpg';
          // console.log("195", img)

          // entity.appendChild(img);
          entity.classList.add('centered')
          scene.appendChild(entity);        
          // setTimeout(()=> {scene.removeChild(entity)}, 5000)
        }
    }

    async function callDex(text){
      try{
        alert("TEXT: "+text)
        const result = await axios.get(`https://cors-anywhere.herokuapp.com/https://dexonline.ro/definitie/${text}/json`);
        console.log(result);
        alert("result" + JSON.stringify(result))
        
        if(result?.data?.definitions?.length>0){
          // am gasit definitie
          const scene = document.getElementById("scene");
          const entity = document.createElement("a-entity");
          entity.innerHTML = result.data.definitions[0].htmlRep;  
          entity.classList.add('centered')
          scene.appendChild(entity);
        
          setTimeout(()=> {scene.removeChild(entity)}, 5000)
          
        } else {
          alert("not found")
         // call fara json (poate gaseste ceva) 
          const result2 = await axios.get(`https://cors-anywhere.herokuapp.com/https://dexonline.ro/definitie/${text}`);
          console.log(result2.data)
          
           const scene = document.getElementById("scene");
          const entity = document.createElement("a-entity");
          entity.innerHTML = result2.data;  
          entity.classList.add('centered')
          scene.appendChild(entity);
        
          // setTimeout(()=> {scene.removeChild(entity)}, 5000)
        }
      } catch(err){
        alert("not found")
        try{
          const result2 = await axios.get(`https://cors-anywhere.herokuapp.com/https://dexonline.ro/definitie/${text}`);
          console.log("172:",result2.data)
          
            const scene = document.getElementById("scene");
          const entity = document.createElement("a-entity");
          entity.classList.add('centered')
          entity.innerHTML = result2.data;     
          scene.appendChild(entity);
        
          // setTimeout(()=> {scene.removeChild(entity)}, 5000)
        } catch(err2){
          console.log("174:",err2)
        }
      }
    }



    
    
  </script>
  <style>
    .buttons {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 10em;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    .take-word-button {
      padding: 0.25em;
      border-radius: 4px;
      border: 1px solid #CCFF00;
      background:#66CC99;
      color: black;
      width: 7em;
      height: 4em;
      font-weight: bold;
    }
    
    .centered{
      width: 155px;
      height: 45px;
      position: absolute;
      top: 50%;
      left: 50%;
      margin-right: -50%;
      transform: translate(-50%, -50%);
    }
    
  </style>
  </head>
  <body style="margin : 0px; overflow: hidden;">
  <canvas id="canvas" width="155" height="45" style="display: none;"></canvas>
    <video id="webcam" width="1280" height="720" autoplay playsinline style="display: none;"></video>
    <div class="buttons">
      <button class="take-word-button">Capture the unknown word!</button>
    </div>
    <div class="centered" style= "border: 4px solid green" id='box'>
    </div>
    <a-scene embedded arjs vr-mode-ui="enabled: false;" id="scene">
      <a-marker preset="hiro">
        <a-entity
          position="0 0 0"
          scale="0.05 0.05 0.05"
          gltf-model="https://arjs-cors-proxy.herokuapp.com/https://raw.githack.com/AR-js-org/AR.js/master/aframe/examples/image-tracking/nft/trex/scene.gltf"
        ></a-entity>
      </a-marker>
      <a-marker preset='kanji'>
        <a-box position='0 0.5 0' material='opacity: 0.5;'></a-box>
      </a-marker>
      <!--<a-marker preset="custom" type="pattern" url="https://drive.google.com/file/d/1Eo6vCIjvnDWduSyyQUzl0lf4EZljBCBk/view?usp=sharing">-->
        <!--<a-entity-->
        <!--   position="0 0 0"-->
        <!--  scale="0.05 0.05 0.05"-->
        <!--  > -->
        <!--</a-entity>-->
        <!--<a-box position='0 0.5 0' material='opacity: 0.5;'></a-box>-->
      <!--</a-marker>-->
      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>